error = struct message as string
doc = struct head as maybe _
head = struct title as maybe string
summary = struct of
  title as maybe string
  ok as bool
end

url = string

read-doc = for url to try doc do
  when
    case url.has "fail" be fail "Bad read of \(url)".format
    else be pass when
      case url.has "head-missing" be _.new
      case url.has "title-missing" be _ head: _.new
      case url.has "title-empty" be _ head: (_ title: "")
      else be "title-empty" be _ head: (_ title: "Title of \(url)".format)
    end
  end
end

build-summary = for doc be summary doc.head?.title ok: True

read-and-build-summary = for url with read-doc be
  (url.read-doc and it.build-summary) or _.new
end

is-title-non-empty = for doc to maybe bool be doc.head?.title?.is-empty.not

read-whether-title-non-empty = for url to try of maybe bool do with read-doc
  url.read-doc?.is-title-non-empty
end

main = for env! with read-doc be
  urls = list "good" "title-empty" "title-missing" "head-missing" "fail"
  print = env.out.print
  urls.each for url do
    env.out.print? 'Checking "https://\(url)/":'
    # Summary.
    summary = url.read-and-build-summary
    "  Summary: \(summary)".print?
    "  Title: \(summary.title or "")".print?
    # Has title.
    has-title = url.read-whether-title-non-empty
    "  Has title: \(has-title) vs \(has-title or "")".print?
  end
end
